<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ø£Ø¯Ø§Ø© Ø¯Ù…Ø¬ Ø£ÙˆØ±Ø§Ù‚ Excel Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ³Ø±Ø¹Ø©</title>
  <meta name="theme-color" content="#2c3e50">
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: linear-gradient(to bottom right, #f0f4f8, #dbe9f4);
      direction: rtl;
      text-align: center;
      padding: 40px;
      color: #333;
      user-select: none;
    }
    h2 {
      font-size: 28px;
      margin-bottom: 10px;
      color: #2c3e50;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    h2::before {
      content: "ğŸ§©";
      font-size: 36px;
    }
    input[type="file"],
    input[type="number"],
    button,
    select {
      margin: 10px;
      padding: 14px 18px;
      font-size: 18px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      width: 90%;
      max-width: 400px;
    }
    button {
      color: white;
      background-color: #3498db;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover {
      background-color: #2980b9;
    }
    label {
      display: block;
      margin-top: 20px;
      font-weight: bold;
      color: #34495e;
      font-size: 18px;
    }
    #status {
      margin-top: 20px;
      font-size: 18px;
      color: #2c3e50;
    }
    .note {
      font-size: 15px;
      color: #7f8c8d;
      margin-top: 10px;
    }
    .invalid {
      background-color: #ffe5e5;
      border-color: #e74c3c;
    }
    #sheetSelectors {
      margin-top: 20px;
    }
    @media (max-width: 600px) {
      body {
        padding: 20px;
      }
      h2 {
        font-size: 24px;
        flex-direction: column;
      }
      input, button, select {
        font-size: 17px;
        padding: 12px;
      }
    }
    #splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(to bottom right, #f0f4f8, #dbe9f4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #2c3e50;
      z-index: 9999;
    }
  </style>
</head>
<body oncontextmenu="return false" onkeydown="return blockKeys(event)">
  <div id="splash">ğŸ§© Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø©...</div>

  <h2>Ø£Ø¯Ø§Ø© Ø¯Ù…Ø¬ Ø£ÙˆØ±Ø§Ù‚ Excel Ø¨Ø³Ù‡ÙˆÙ„Ø© ÙˆØ³Ø±Ø¹Ø©</h2>
  <input type="file" id="fileInput" multiple accept=".xlsx,.csv"><br>
  <label for="sheetIndex">ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¯Ù…Ø¬Ù‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
  <input type="number" id="sheetIndex" min="1" placeholder="Ù…Ø«Ù„Ø§Ù‹: 1" oninput="applyGlobalSheetIndex()"><br>
  <div id="sheetSelectors"></div>
  <button onclick="mergeFiles()">âœ… Ø¯Ù…Ø¬ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
  <button onclick="resetForm()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
  <p id="status"></p>
  <p class="note">âš ï¸ Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ± Ù…Ù† WindowsØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙˆÙ‡Ùˆ Ø¢Ù…Ù† ØªÙ…Ø§Ù…Ù‹Ø§.</p>

  <script>
    window.addEventListener('load', () => {
      setTimeout(() => {
        document.getElementById('splash').style.display = 'none';
      }, 1500);
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(() => console.log('âœ… Service Worker Ù…Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­'))
        .catch(err => console.error('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker', err));
    }

    const sheetSelectors = document.getElementById('sheetSelectors');
    const status = document.getElementById('status');
    let fileSheetMap = {};

    document.getElementById('fileInput').addEventListener('change', async function () {
      const files = Array.from(this.files);
      sheetSelectors.innerHTML = '';
      fileSheetMap = {};
      status.textContent = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª...";

      const loadPromises = files.map(file => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              let workbook;
              const data = e.target.result;
              if (file.name.endsWith('.csv')) {
                workbook = XLSX.read(data, { type: 'binary' });
              } else {
                workbook = XLSX.read(data, { type: 'array' });
              }

              const sheetNames = workbook.SheetNames;
              fileSheetMap[file.name] = { workbook, sheetNames };

              const label = document.createElement('label');
              label.textContent = `ğŸ—‚ï¸ Ø§Ø®ØªØ± Ø§Ù„ÙˆØ±Ù‚Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù: ${file.name}`;

              const select = document.createElement('select');
              select.className = 'sheet-select';
              select.name = file.name;

              sheetNames.forEach((name, index) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = `(${index + 1}) ${name}`;
                select.appendChild(option);
              });

              sheetSelectors.appendChild(label);
              sheetSelectors.appendChild(select);
              resolve();
            } catch (err) {
              reject(err);
            }
          };

          if (file.name.endsWith('.csv')) {
            reader.readAsBinaryString(file);
          } else {
            reader.readAsArrayBuffer(file);
          }
        });
      });

      try {
        await Promise.all(loadPromises);
        status.textContent = "âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„Ø¯Ù…Ø¬.";
      } catch {
        status.textContent = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª.";
      }
    });

    function applyGlobalSheetIndex() {
      const index = parseInt(document.getElementById('sheetIndex').value) - 1;
      const selects = document.querySelectorAll('.sheet-select');

      selects.forEach(select => {
        select.classList.remove('invalid');
        if (!isNaN(index) && index >= 0 && index < select.options.length) {
          select.selectedIndex = index;
        } else {
          select.classList.add('invalid');
        }
      });
    }

    async function mergeFiles() {
      const files = Array.from(document.getElementById('fileInput').files);
      if (!files.length) {
        status.textContent = "âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£ÙŠ Ù…Ù„ÙØ§Øª.";
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹");
        return;
      }

      status.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ù…Ø¬...";
      const mergedWorkbook = XLSX.utils.book_new();

      for (const file of files) {
        const fileData = fileSheetMap[file.name];
        if (!fileData) continue;

        const { workbook } = fileData;
        const selectedSheet = document.querySelector(`select[name="${file.name}"]`).value;
        const worksheet = workbook.Sheets[selectedSheet];
        if (!worksheet) continue;

        const cleanName = (file.name.replace(/\.(xlsx|xls|csv)$/i, '') + '_' + selectedSheet)
          .replace(/[\[\]\:\*\?\/\\]/g, '')
          .substring(0, 31);

        XLSX.utils.book_append_sheet(mergedWorkbook, worksheet, cleanName);
      }

      const mergedData = XLSX.write(mergedWorkbook, {
        bookType: 'xlsx',
        type: 'array'
      });

      const blob = new Blob([mergedData], {
        type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      });

      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "merged.xlsx";
      document.body.appendChild(link);
      link.click();